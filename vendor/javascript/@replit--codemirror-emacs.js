import{Prec as e,StateEffect as t,StateField as a,MapMode as r,EditorSelection as n}from"@codemirror/state";import{EditorView as s,Direction as o,ViewPlugin as i,keymap as c,showPanel as l}from"@codemirror/view";import*as m from"@codemirror/commands";import{startCompletion as u}from"@codemirror/autocomplete";import{openSearchPanel as d}from"@codemirror/search";class Piece{constructor(e,t,a,r,n,s){this.left=e;this.top=t;this.height=a;this.className=r;this.letter=n;this.partial=s}draw(){let e=document.createElement("div");e.className=this.className;this.adjust(e);return e}adjust(e){e.style.left=this.left+"px";e.style.top=this.top+"px";e.style.height=this.height+"px";e.style.lineHeight=this.height+"px";e.style.color=this.partial?"transparent":"";e.className=this.className;e.textContent=this.letter}eq(e){return this.left==e.left&&this.top==e.top&&this.letter==e.letter&&this.height==e.height&&this.className==e.className}}class BlockCursorPlugin{constructor(e){this.view=e;this.rangePieces=[];this.cursors=[];this.measureReq={read:this.readPos.bind(this),write:this.drawSel.bind(this)};this.cursorLayer=e.scrollDOM.appendChild(document.createElement("div"));this.cursorLayer.className="cm-cursorLayer cm-vimCursorLayer";this.cursorLayer.setAttribute("aria-hidden","true");e.requestMeasure(this.measureReq);this.setBlinkRate()}setBlinkRate(){this.cursorLayer.style.animationDuration="1200ms"}update(e){if(e.selectionSet||e.geometryChanged||e.viewportChanged){this.view.requestMeasure(this.measureReq);this.cursorLayer.style.animationName="cm-blink"==this.cursorLayer.style.animationName?"cm-blink2":"cm-blink"}}scheduleRedraw(){this.view.requestMeasure(this.measureReq)}readPos(){let{state:e}=this.view;let t=[];for(let a of e.selection.ranges){let r=a==e.selection.main;let n=measureCursor(null,this.view,a,r);n&&t.push(n)}return{cursors:t}}drawSel({cursors:e}){if(e.length!=this.cursors.length||e.some(((e,t)=>!e.eq(this.cursors[t])))){let t=this.cursorLayer.children;if(t.length!==e.length){this.cursorLayer.textContent="";for(const t of e)this.cursorLayer.appendChild(t.draw())}else e.forEach(((e,a)=>e.adjust(t[a])));this.cursors=e}}destroy(){this.cursorLayer.remove()}}const h={".cm-line":{"& ::selection":{backgroundColor:"transparent !important"},"&::selection":{backgroundColor:"transparent !important"},caretColor:"transparent !important"},".cm-fat-cursor":{position:"absolute",background:"#ff9696",border:"none",whiteSpace:"pre"},"&:not(.cm-focused) .cm-fat-cursor":{background:"none",outline:"solid 1px #ff9696"}};const g=e.highest(s.theme(h));function getBase(e){let t=e.scrollDOM.getBoundingClientRect();let a=e.textDirection==o.LTR?t.left:t.right-e.scrollDOM.clientWidth;return{left:a-e.scrollDOM.scrollLeft,top:t.top-e.scrollDOM.scrollTop}}function measureCursor(e,t,a,r){let n=a.head;var s=1;let o=t.coordsAtPos(n,1);if(!o)return null;let i=getBase(t);let c=n<t.state.doc.length&&t.state.sliceDoc(n,n+1);c&&"\n"!=c&&"\r"!=c||(c="Â ");let l=o.bottom-o.top;return new Piece(o.left-i.left,o.top-i.top+l*(1-s),l*s,r?"cm-fat-cursor cm-cursor-primary":"cm-fat-cursor cm-cursor-secondary",c,1!=s)}const f=s.theme({".cm-emacsMode .cm-cursorLayer:not(.cm-vimCursorLayer)":{display:"none"},".cm-vim-panel":{padding:"5px 10px",backgroundColor:"#fffa8f",fontFamily:"monospace"},".cm-vim-panel input":{border:"none",outline:"none",backgroundColor:"#fffa8f"}});const p=i.fromClass(class{constructor(e){this.status="";this.view=e;this.em=new EmacsHandler(e);this.blockCursor=new BlockCursorPlugin(e);this.view.scrollDOM.classList.add("cm-emacsMode")}update(e){if(e.docChanged){this.em.$emacsMark=null;this.em.updateMarksOnChange(e.changes)}this.blockCursor.update(e)}destroy(){this.view.scrollDOM.classList.remove("cm-emacsMode");this.blockCursor.destroy()}},{eventHandlers:{mousedown:function(){this.em.$emacsMark=null}},provide:e=>c.of([{any:function(t,a){var r;return!!(null===(r=t.plugin(e))||void 0===r?void 0:r.em.handleKeyboard(a))}}])});const v=t.define();const C=a.define({create:()=>false,update(e,t){for(let a of t.effects)a.is(v)&&(e=a.value);return e},provide:e=>l.from(e,(e=>e?createVimPanel:null))});function createVimPanel(e){let t=document.createElement("div");t.className="cm-vim-panel";return{top:false,dom:t}}function emacs(e={}){return[f,p,g,C]}var k={Return:"Return",Escape:"Esc",Insert:"Ins",ArrowLeft:"Left",ArrowRight:"Right",ArrowUp:"Up",ArrowDown:"Down",Enter:"Return",Divide:"/",Slash:"/",Multiply:"*",Subtract:"-",Minus:"-",Equal:"="};var M={Shift:1,Alt:1,Command:1,Control:1,CapsLock:1};const w={};class EmacsHandler{constructor(e){this.view=e;this.$data={count:0,keyChain:"",lastCommand:""};this.$emacsMarkRing=[];this.$emacsMark=null}static bindKey(e,t){e.split("|").forEach((function(e){let a="";let r=e.split(/\s+/);r.forEach((function(e,n){let s=e.split(/-(?=.)/);let o=s.pop();s.length&&(a+=s.sort().join("-")+"-");a+=o;if(n===r.length-1)w[a]=t;else{w[a]="null";a+=" "}}))}))}static getKey(e){var t=e.code;var a=e.key;if(M[a])return["","",""];if(t.length>1){"N"==t[0]&&(t=t.replace(/^Numpad/,""));"K"==t[0]&&(t=t.replace(/^Key/,""))}t=k[t]||t;1==t.length&&(t=t.toLowerCase());var r="";e.ctrlKey&&(r+="C-");e.metaKey&&(r+="CMD-");e.altKey&&(r+="M-");e.shiftKey&&(r+="S-");return[t,r,a]}static addCommands(e){Object.keys(e).forEach((function(t){var a=e[t];"function"==typeof a&&(a={exec:a});EmacsHandler.commands[t]=a}))}static execCommand(e,t,a,r=1){var n=void 0;if("function"===typeof e)for(var s=0;s<r;s++)e(t.view);else if("null"===e);else{if(!e.exec)throw new Error("missformed command");if(r>1&&e.handlesCount){a||(a={});"object"===typeof a&&(a.count=r);r=1}for(s=0;s<r;s++)n=e.exec(t,a||{})}return n}handleKeyboard(e){var t=EmacsHandler.getKey(e);var a=this.findCommand(t);if(a&&a.command){var r=EmacsHandler.execCommand(a.command,this,a.args,a.count);if(false===r)return}return a}findCommand([e,t,a]){if(e){var r=this;var n=this.$data;if(!t&&1==e.length){r.pushEmacsMark();if(n.count){var s=new Array(n.count+1).join(a);n.count=null;return{command:"insertstring",args:s}}}if("C-"==t||n.count){var o=parseInt(e[e.length-1]);if("number"===typeof o&&!isNaN(o)){n.count=Math.max(n.count||0,0);n.count=10*n.count+o;return{command:"null"}}}t&&(e=t+e);n.keyChain&&(e=n.keyChain+=" "+e);var i=w[e];n.keyChain="null"==i?e:"";if(i){if("null"===i)return{command:"null"};if("universalArgument"===i){n.count=-4;return{command:"null"}}var c;if("string"!==typeof i){c=i.args;i.command&&(i=i.command)}"insertstring"!==i&&i!==m.splitLine&&i!==m.toggleComment||r.pushEmacsMark();if("string"===typeof i){i=EmacsHandler.commands[i];if(!i)return}i.readOnly||i.isYank||(n.lastCommand=null);o=n.count||1;n.count&&(n.count=0);return{command:i,args:c,count:o}}}}showCommandLine(e){console.error("TODO")}updateMarksOnChange(e){this.$emacsMark&&(this.$emacsMark=this.updateMark(this.$emacsMark,e));this.$emacsMarkRing=this.$emacsMarkRing.map((t=>this.updateMark(t,e))).filter(Boolean)}updateMark(e,t){if(e){var a=e.map((function(e){return t.mapPos(e,1,r.TrackDel)})).filter((e=>null!=e));return 0==a.length?null:a}}emacsMark(){return this.$emacsMark}setEmacsMark(e){this.$emacsMark=e}pushEmacsMark(e,t){var a=this.$emacsMark;a&&this.$emacsMarkRing.push(a);!e||t?this.setEmacsMark(e):this.$emacsMarkRing.push(e)}popEmacsMark(){var e=this.emacsMark();if(e){this.setEmacsMark(null);return e}return this.$emacsMarkRing.pop()}getLastEmacsMark(){return this.$emacsMark||this.$emacsMarkRing.slice(-1)[0]}getCopyText(){var e=this.view.state;return e.selection.ranges.map((t=>e.sliceDoc(t.from,t.to))).join("\n")}clearSelection(){var e=this.view;var t=e.state.selection;var a=!t.ranges.some((e=>e.from!=e.to));if(a)return false;var r=t.ranges.map((e=>n.range(e.head,e.head)));e.dispatch({selection:n.create(r,t.mainIndex)});return true}onPaste(e){var t=this.view;var a=t.state.selection;var r;if(a.ranges.length>1){var s=e.split("\n");s.length==a.ranges.length&&(r=s)}var o=0;var i=t.state.changeByRange((t=>{var a=r?r[o]:e;o++;return{changes:{from:t.from,to:t.to,insert:a},range:n.cursor(t.from+a.length)}}));t.dispatch(i)}}EmacsHandler.commands={};const y={"Up|C-p":{command:"goOrSelect",args:[m.cursorLineUp,m.selectLineUp]},"Down|C-n":{command:"goOrSelect",args:[m.cursorLineDown,m.selectLineDown]},"Left|C-b":{command:"goOrSelect",args:[m.cursorCharBackward,m.selectCharBackward]},"Right|C-f":{command:"goOrSelect",args:[m.cursorCharForward,m.selectCharForward]},"C-Left|M-b":{command:"goOrSelect",args:[m.cursorGroupLeft,m.selectGroupLeft]},"C-Right|M-f":{command:"goOrSelect",args:[m.cursorGroupRight,m.selectGroupRight]},"Home|C-a":{command:"goOrSelect",args:[m.cursorLineStart,m.selectLineStart]},"End|C-e":{command:"goOrSelect",args:[m.cursorLineEnd,m.selectLineEnd]},"C-Home|S-M-,":{command:"goOrSelect",args:[m.cursorDocStart,m.selectDocStart]},"C-End|S-M-.":{command:"goOrSelect",args:[m.cursorDocEnd,m.selectDocEnd]},"S-Up|S-C-p":m.selectLineUp,"S-Down|S-C-n":m.selectLineDown,"S-Left|S-C-b":m.selectCharBackward,"S-Right|S-C-f":m.selectCharForward,"S-C-Left|S-M-b":m.selectGroupBackward,"S-C-Right|S-M-f":m.selectGroupForward,"S-Home|S-C-a":m.selectLineStart,"S-End|S-C-e":m.selectLineEnd,"S-C-Home":m.selectDocStart,"S-C-End":m.selectDocEnd,"C-l":"recenterTopBottom","M-s":"centerSelection","M-g":"gotoline","C-x C-p|C-x h":m.selectAll,"PageDown|C-v|C-Down":{command:"goOrSelect",args:[m.cursorPageDown,m.selectPageDown]},"PageUp|M-v|C-Up":{command:"goOrSelect",args:[m.cursorPageUp,m.selectPageDown]},"S-C-Down":m.selectPageDown,"S-C-Up":m.selectPageUp,"C-s":d,"C-r":d,"M-C-s":"findnext","M-C-r":"findprevious","S-M-5":"replace",Backspace:m.deleteCharBackward,"Delete|C-d":m.deleteCharForward,"Return|C-m":{command:"insertstring",args:"\n"},"C-o":m.splitLine,"M-d|C-Delete":{command:"killWord",args:"right"},"C-Backspace|M-Backspace|M-Delete":{command:"killWord",args:"left"},"C-k":"killLine","M-h":"selectParagraph","M-@|M-S-2":"markWord","C-y|S-Delete":"yank","M-y":"yankRotate","C-g":"keyboardQuit","C-w|C-S-w":"killRegion","M-w":"killRingSave","C-Space":"setMark","C-x C-x":"exchangePointAndMark","C-t":m.transposeChars,"M-u":{command:"changeCase",args:{dir:1}},"M-l":{command:"changeCase",args:{dir:-1}},"C-x C-u":{command:"changeCase",args:{dir:1,region:true}},"C-x C-l":{command:"changeCase",args:{dir:1,region:true}},"M-/":u,"C-u":"universalArgument","M-;":m.toggleComment,"C-/|C-x u|S-C--|C-z":m.undo,"S-C-/|S-C-x u|C--|S-C-z":m.redo,"C-x r":"selectRectangularRegion","M-x":{command:"focusCommandLine",args:"M-x "},Esc:"unsetTransientMark"};for(let e in y)EmacsHandler.bindKey(e,y[e]);EmacsHandler.addCommands({unsetTransientMark:function(e){e.setEmacsMark(null);return false},markWord:function(e,t){},selectParagraph:function(e,t){var a=e.view;var r=a.state.selection.ranges[0].head;var s=a.state.doc;var o=s.lineAt(r);var i=-1;var c=-1;var l=o;while(/\S/.test(l.text)&&l.from>0){i=l.from;l=a.state.doc.lineAt(l.from-1)}if(-1==i)while(!/\S/.test(l.text)&&l.to<s.length){i=l.from;l=a.state.doc.lineAt(l.to+1)}else l=o;while(/\S/.test(l.text)&&l.to<s.length){c=l.to;l=a.state.doc.lineAt(l.to+1)}-1==c&&(c=o.to);var m=[n.range(i,c)];a.dispatch({selection:n.create(m)})},goOrSelect:{exec:function(e,t){var a=e.emacsMark()?t[1]:t[0];a(e.view)}},changeCase:function(e,t){var a=e.view;if(!t.region){e.clearSelection();m.selectGroupForward(a)}var r=a.state.changeByRange((e=>{var r=a.state.sliceDoc(e.from,e.to);r=1==t.dir?r.toUpperCase():r.toLowerCase();return{changes:{from:e.from,to:e.to,insert:r},range:n.cursor(e.from+r.length)}}));a.dispatch(r)},centerSelection:function(e){e.view.dispatch({scrollIntoView:true})},recenterTopBottom:function(e){var t=e.view;var a=t.scrollDOM.scrollTop;t.dispatch({scrollIntoView:true});try{t.measure(true)}catch(e){}if(a==t.scrollDOM.scrollTop){var r=t.scrollDOM.getBoundingClientRect();var n=t.coordsAtPos(t.state.selection.main.head);if(n){var s=n.bottom-n.top;var o=r.height;var i=n.top-r.top;Math.abs(i)<s/4?a+=i+s-o+2:Math.abs(i-.5*o)<s/4?a+=i-2:a+=i-.5*o;t.scrollDOM.scrollTop=a}}},selectRectangularRegion:function(e){var t=e.view;var a=t.state.selection.ranges;var r=[];if(a.length>1)r.push(n.range(a[0].from,a[a.length-1].to));else{let e=t.state.doc;let s=e.lineAt(a[0].from);let o=e.lineAt(a[0].to);let i=a[0].from-s.from;let c=a[0].to-o.from;while(s.from<o.to){r.push(n.range(s.from+i,s.from+c));if(s.to+1>=e.length)break;s=e.lineAt(s.to+1)}}t.dispatch({selection:n.create(r)})},setMark:{exec:function(e,t){var a=e.view;var r=a.state.selection.ranges;if(t&&t.count){var s=e.popEmacsMark();if(s){var o=s.map((e=>n.cursor(e,e)));a.dispatch({selection:n.create(o)})}}else{s=e.emacsMark();var i=r.map((function(e){return e.from}));var c=r.every((function(e){return e.from==e.to}));if(!s&&c)if(s);else{e.pushEmacsMark(i);e.setEmacsMark(i)}else{e.clearSelection();s&&e.pushEmacsMark(null)}}},readOnly:true,handlesCount:true},exchangePointAndMark:{exec:function exchangePointAndMark$exec(e,t){var a=e.view;var r=a.state.selection;var s=!r.ranges.some((e=>e.from!=e.to));if(t.count||s){var o=e.$emacsMarkRing;var i=o[o.length-1];if(i)if(t.count){e.clearSelection();m=i.map((e=>n.range(e,e)));a.dispatch({selection:n.create(m,r.mainIndex)})}else{var c=Math.min(i.length,r.ranges.length);m=[];for(var l=0;l<c;l++)m.push(n.range(r.ranges[l].head,i[l]))}}else{var m=r.ranges.map((e=>n.range(e.head,e.anchor)));a.dispatch({selection:n.create(m,r.mainIndex)})}},readOnly:true,handlesCount:true},killWord:{exec:function(e,t){var a=e.view;var r=a.state.selection;var s=r.ranges.map((e=>n.range(e.head,e.head)));a.dispatch({selection:n.create(s,r.mainIndex)});"left"==t?m.selectGroupBackward(a):m.selectGroupForward(a);r=a.state.selection;r.ranges.forEach((e=>{var t=a.state.sliceDoc(e.from,e.to);S.add(t)}));a.dispatch(a.state.replaceSelection(""))}},killLine:function(e){e.pushEmacsMark(null);e.clearSelection();m.selectLineEnd(e.view);var t=e.view;var a=t.state;var r=[];var n=e.view.state.selection.ranges.map((function(e){var t=e.from;var n=e.to;var s=a.sliceDoc(t,n);r.push(s);if(/^\s*$/.test(s)){n+=1;r.push("\n")}return{from:t,to:n,insert:""}}));"killLine"==e.$data.lastCommand?S.append(r.join("\n")):S.add(r.join("\n"));t.dispatch({changes:n})},yank:function(e){e.onPaste(S.get());e.$data.lastCommand="yank"},yankRotate:function(e){if("yank"==e.$data.lastCommand){m.undo(e.view);e.$emacsMarkRing.pop();e.onPaste(S.rotate());e.$data.lastCommand="yank"}},killRegion:{exec:function(e){S.add(e.getCopyText());var t=e.view;t.dispatch(t.state.replaceSelection(""));e.setEmacsMark(null)}},killRingSave:{exec:function(e){var t=e.getCopyText();S.add(t);e.clearSelection();navigator.clipboard.writeText(t)},readOnly:true},keyboardQuit:function(e){var t=e.view;var a=t.state.selection;var r=!a.ranges.some((e=>e.from!=e.to));if(a.ranges.length>1&&!r){var s=a.ranges.map((e=>n.range(e.head,e.head)));t.dispatch({selection:n.create(s,a.mainIndex)})}else m.simplifySelection(e.view);e.setEmacsMark(null);e.$data.count=null},focusCommandLine:function(e,t){e.showCommandLine(t)}});const S={$data:[],add:function(e){e&&this.$data.push(e);this.$data.length>30&&this.$data.shift()},append:function(e){var t=this.$data.length-1;var a=this.$data[t]||"";e&&(a+=e);a&&(this.$data[t]=a)},get:function(e){e=e||1;return this.$data.slice(this.$data.length-e,this.$data.length).reverse().join("\n")},pop:function(){this.$data.length>1&&this.$data.pop();return this.get()},rotate:function(){let e=this.$data.pop();e&&this.$data.unshift(e);return this.get()}};export{emacs,y as emacsKeys};

